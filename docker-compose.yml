# [최종 수정] docker-compose.yml

services:
  # 1. Node.js 서비스 정의
  nodejs-app:
    container_name: attention-nodejs
    image: hwengdeong/attention-app:latest
    ports:
      - "3000:3000"
    restart: always
    networks:
      - attention-network
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379

  # 2. Redis 서비스 정의
  redis:
    container_name: attention-redis
    image: "redis:alpine"
    restart: always
    networks:
      - attention-network

  # 3. 데이터 저장 서비스 (Python)
  session-data-saver:
    container_name: attention-data-saver
    build:
      context: ./sessionDataSave
      dockerfile: Dockerfile
    restart: always
    networks:
      - attention-network
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    volumes:
      - ./dataStorage:/app/dataStorage

      # 4. Rust 웹소켓 서비스
  websocket:
    container_name: attention-websocket
    build:
      # 이 서비스의 빌드 컨텍스트는 'websocket' 폴더입니다.
      context: ./websocket
      dockerfile: Dockerfile
    ports:
      # EC2의 9001번 포트를 컨테이너의 9001번 포트로 연결합니다.
      - "9001:9001"
    restart: always
    networks:
      - attention-network
    environment:
      # 이 서비스도 Redis에 접속해야 하므로 환경 변수를 주입합니다.
      - REDIS_HOST=redis
      - REDIS_PORT=6379


networks:
  attention-network:
    driver: bridge
